// Copyright 2016 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package types

import (
	"errors"
	"math/big"
	"testing"

	"github.com/theQRL/go-zond/common"
	"github.com/theQRL/go-zond/crypto"
	"github.com/theQRL/go-zond/crypto/pqcrypto"
	"github.com/theQRL/go-zond/rlp"
)

func TestShaghaiSigning(t *testing.T) {
	key, _ := crypto.GenerateMLDSA87Key()
	addr := pqcrypto.MLDSA87ToAddress(key)

	signer := NewShanghaiSigner(big.NewInt(18))
	tx, err := SignTx(NewTx(&DynamicFeeTx{Nonce: 0, To: &addr, Value: new(big.Int), Gas: 0, GasFeeCap: new(big.Int), Data: nil}), signer, key)
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(signer, tx)
	if err != nil {
		t.Fatal(err)
	}
	if from != addr {
		t.Errorf("exected from and address to be equal. Got %x want %x", from, addr)
	}
}

func TestEIP155ChainId(t *testing.T) {
	key, _ := crypto.GenerateMLDSA87Key()
	addr := pqcrypto.MLDSA87ToAddress(key)

	signer := NewShanghaiSigner(big.NewInt(18))
	tx, err := SignTx(NewTx(&DynamicFeeTx{Nonce: 0, To: &addr, Value: new(big.Int), Gas: 0, GasFeeCap: new(big.Int), Data: nil}), signer, key)
	if err != nil {
		t.Fatal(err)
	}

	if tx.ChainId().Cmp(signer.ChainID()) != 0 {
		t.Error("expected chainId to be", signer.ChainID(), "got", tx.ChainId())
	}
}

func TestShaghaiSigningVitalik(t *testing.T) {
	// NOTE(rgeraldes24): url not working; original test vectors are not of much use
	// Test vectors come from http://vitalik.ca/files/eip155_testvec.txt
	for i, test := range []struct {
		txRlp, addr string
	}{
		{"b91c2602f91c220101808080808080c0b90a2001727d783cc48b50060e8d3cf86eb8f37a5fe0dd49beb6c79e77aa4243aed4acdc5bed459f9ce1aaee191558c4791a698778f22ae0b670dbc963f9dff974c5c4c7bdf86504364cd48ecbd37c990758e92abc82f9ab42eefac09b5c307064540751421eff33e436f05f59c0a43a3c1b93442fb8b75bc4ca7156310162c935c50dfea28b8f8cb3409edb3a3b8242ddc9320f97e2e9f3d50f4428d791d7969e412ba10a2b22c6229395dd86f86261104f3cf37617d370d28f484b2605828f03b017d898baf4b4631212baef96e81c017dab349d8189a70f07bfe86240d5f5a33802ca794072aef09b4171b153af2b33a8b375a113438d271cb0fe625d76e8fcca390dcbb924abf7ac9bc5e6ea6ec38cc7b4fb38ac22ded5d9280260c53f87186e8a1f44eeca54fd915015daeaa57fa3493130dbc0e3b664df05bce6cfbe8c10c1a7b7963ec5d9f6e044995050bc169b62de61e37e91eb83e0f21aa11018edd4f2587b2c907e1f99fc93a30935a9a16c828e778acb8d04e70e6a4cf248a1f23088fcde603ae156e538c1f2cc07e959f1a0d5d8771ee207284edc9e5f34785f708a9f1395cdbbd17fdfaa0792d9ffa1af4dec2907b603698bc71621df7e34c6adf001951252b97d69590d7cbf7a102734aca33b3a337ce3deec222f2b8b61c45ad189a75dd30746ec7c9700fccf361b94b23564c974bd024b89a52d3f225d0b562e4500b51e0c447caeff5eb760d781c416aabf702c079baad87fdb18c61d50cc8827e407fe088a8da4575a92e13093d24c63ff37ac70bb2a6be9631891b0dd570a7fbb73bb66d489058ac89c46db31576a38dbe2a206a31f48751b45e1bf7934fd8fc2d242273aa1261ca679a6ce693a458a5a33d47d8b7a8aa61f62060424bcf911f147206c475842c16dd801e4ac32a8223215ad3a4e59deb4df0597a612c330af5a787f05327cc5cac9e8a9d151adfb0413b5a68f124d9f1cbe753137061f5beb8ec2b9be66ea23076f2d6da6624a983f76ad92235315a3883c2a321b013586c055941514d3a6d448ff1d6cef057e4ca26b944d44086f4df7970371464c56151221cb808f0e00818cd0ffa916b78e696132ccc71a795949a39f2a5a6acff20998c085e640c901f251998d15d6cb7092dc48e69284e4836e634db47664f926697055252be841a5a79603f8a2a419650a6f1ad7c6bdb11a391bdea76f4f68be08922f5ef08bff8c0d02d5aded7907642cc6cca4fd594f0fe4700efd15827ae2f4a9c7f8f629498f1992e4cb575ed9bedb1927bd57bde751624a34c8438892ac114cbe1aac962cf4fe199d2ff2a23cb1f8c3a3e6d78a8b44b66d8f25c3702bebbfb1974698ac701d263561a32cec56574e1eb9f289fac40fa441296d79ae4f0f51c8e9a50d7acc1779b5a47a806c692a1c49e99fafb63d2149eeb175aa7ef584cbb5504211fbe6585e30ba0edbb717decc3494ee984d5f3e56089f14ce7222c6573833377881a861fd763e4fb667c9e76c860ffdee0771465f5a37aad543e3fa5f024996dba344f6a1c24b245a45adc6a18ac4dd08bb0307910724007e344ad302b534dcf7dd2ac3966bd3668486ba361ac1390155c0e1334d3a79c631f889bb26dda72449129d4441e795f2c124cde229d4daf79bc9f15c562fc0f6faa47f6b757cf4c7d0d6271c1e47f3d01ac02938eef495ca61e051617f32693a17abacf604722025f72660979716407f15d56a71b1427019b2b8897a7991f6d9bead653b537670bf4c5e7bc54b8745b533ab4bb96b588bdeb2b4f713f25477688737dde64107d82feabc00a2689f27b1b58161b6281d9edd647b8d23e9442f2123c93365f6805cf903b8a802a2de6d5622407cb9d88512fcc9ba9f18c90cfaa80e1e9f985e9849c8b91d9cdc1f862135f6583aed4f5471124408a89081c0e14789ce8f2444dee55f789387e6e48e6212fd271a1e3a55de0c1e122c8772dc32d1ca77284eb4649e86ae6e5569a4cf840166970a21d79c50a8fc9b2d1c144ee79885ffdbc22737b03a110b3522ea5c26ae99f950aec20411cd1c2466df4d90c3ffe2ed9116b6c23a63299f6d7bbcf2a37368765d170297d900ca346fa60f0e6a3fccf2a01548219982c5e49444771e64619089da4c6263df7ac2693d9037800f68607a34d7eeb489b1a93030488d7cd407f4f2ab561701d884d7eeea39f79cf2f25c4da089f34ea3f3dc15da1bc43da8e7c12d1e0c05b107f10da1ea5a684331f2ecb696734b47407dc51a15ab9c9b98f31a42cb2e771696ab39378bbcfec21021bc42ffb1488920229589505bb6fc771edddb1818a081a5b8fc90eefba70091ea3fed3fe81f95f721570662eed03cfd759fb064e2401e634072557f025cce8affff8c062381b5e0291fb016292b5403848b419037d9bb6190045eb19454c2ea2debec95eb9d7f76f9546c922f96d1a04c537594ef5d26b226821a3527cebd56ac950c54e7fa0557e017e9a5974ae7defbe1fb3ba3037f89d12ea7f85253ef885af0da7b1e60a8637d1197b795a9d663723b94f1806b2938b5da325877d7b85ec544bbf311f75cb7e17999518cb473a5cb7875ba4e59a904cc09992313ee3f44890498af5443d983a4ad2669fee3c47d592e788c56419b1e93bdaa5434ce895506adde41e75f89dce82e6fc78cf0b85850808037c172d5a44848525d1f06cc7f3610adf434ae21c1313c438eaf9b0cd4d18d4f402279a7db469080ee807630b0388046551ca3476914e3a2a2abc0b7fc211fc17a48c0b42800406738dce93b19a64dcc3cb93435ec117462ddcfd396daf99acd0bf2037a21fce0a46dbbfd974121669287f409a778b538f862eade58da183e9bd37c763a16f56b15d8d0c8ab6326189ca7116c587b87659ae82be17639362ecaa78f7ad346ae82a8f85bdf0ddc38054b9239ce975ee723ffc854ae4d028c20dae5d7cbd1b110dd749049c89878f797a20fc15ea9f6839c130253d4fa6d506fecd3605a8dfa35b13ff61e2f9d865224df588cf8d51d00341b8c607b64158903c171d76e7b303d0d1349374f6f06f080db74f55ecbbf8a038cc209bc4d86d63d9c8b7309a423b29048abdfb8849196bdea7a2a55a9b6f3c4e8019cc80bde6e6ddff2bac293c50f4f739a21331495b960a242d2d126832283f09a9d0ef145ca9cd5b513c7d72e2670717709e169e03d4d618ba6c319ac03a4c65cf7cdd050745f0ce0f7872fff4640741284ee26f1585e05978e53e1fff5a89322e9b770bc29c697e9843157f9f797f37ed45f9992e333d780fb71ea992624c195d0e8dc008877a5adaa89d8aef5b6533c2481208a946a5b32f3c95e4e518fc1c2e76bbceee2ce18703ce38e86cc09bdfda8b90c0beb6a7ce0321f9f8acd27f93800cc79dfd671825974516554e68ed1953a80d9e1a51717f06e2392612843eb73783eb74d1db18ee8c56929ac41bec655957cccf68ab3810cfb099aea1a1d7e064afe0b248d60d8aca916bc5529555ad94af922481f535f60a060ec63b887b183378355a827dc0da8a87fef209dd79ad207c482423f2d45fd4e4e8019122afe9bf5e4fac379567c13f44c35061fbdab4939f429354f4841cb1f15ec30fd69b361596e1259edb9f506a80dcd5a17786f4eb8e35fc1556fc9fbdf18d9b911f347d7aeec60ba57939e7f57dd9713de8ad9c9f177290d671b569ee26e7e7a37fd34a99744335ee1f4b8a6e10bc3e76ef182f4ca4278d71ed33e2c0551726f75a6a1c81e9d115b6dfabb6e2e85a05df7590ba80e1b501ccb1ab1750a6690a99fce6b72d02e3f7fb58969c3c8c3ef867471b499c943aad51d7564085278edd0cd139955db5a1b200c9f13be96f654f1ade680cb492d727d8a6112534aac8f96e52f237c33ab53fc332f4d4bc123b33abe8bb18fcef7da2887006da7d75648fae9836a17b6e5dd2eec8d5bc679e64741fdd4e92422f45b36fcb6bcd39e8e7fa25c8a287dd4e29691fe810e0c78423f664e29357029535cd61c9c3175e76a92599162f639a0c06788123daa1939e2c5865f66a530fea6568c5fb00356093ab4e7b2daad0e10f9bc45d62e9f3330306ee315b5bd3dfbef956b447e79d87f8fda337f7b1b278f346d2369fa3ee5f31c315603ae56c168c0ade4c2369d65b1b6cdb4b78b688fd46e0e93dfbb4de169a677eccffe92dfd6a1f40bb2aefc0cd0fed3e8f2520f94c9417733d097886e5dc936e47b0b9a18a463ee8b8ffd8fd3f8ec448ded9cfe0f9265aa94891709a51a0759bfe74edc7b851def5cf23b248fc743968ff8aa521cdb403c6a34579f5e5f0f569dccc13484849b439487058d4fbe18a63a078bc75688b0cf11cf9d567ee4573608b95aee1b540adbd8618407c29adfffa2d3f02eb2fbaa860b3268f13dae4ca2aa1e121342bcbe639473e9c5a50d2c2280f57c33abb24f10b87738bdc51a49a9dc784cd68703cdc6ba121f6e52ecd654a3d72bedc70c356fd00c49f5fd19e978392984ca27c6584a4be120e2927cec23d7dd36b7dd537bace666a7e30ee10ef8cbdbd0f78c63c524cfeef59de633f7728e70a29310911473e4a22e4f80fc76b29a2c6f2063d0e3fdacb168ed83242795b5457d0f2002adbcecd9c251a33eabce58c6370e2d7d74c9e66c5de16c6c36020c78b25314515e6dfc298a7ccbcc12bb5d117e441681685dfc94ae69862d35944d51aa60423ff3d1c65c55188a0ef6893cd7af9b8c82c940f354992e998b3fa16f3c0dd007d99067fade2033e2e4cfc013257699b0f4ed10f84a1b6a5a040764392d7081fb4d42e87594de78082015c63457fcd1fffa051502281c066cc89fbcdc2cbd17e0eaa00ffda6114796163239af5fae1b9b25a619e17cda24f67774f4315b1e585a79aced0780d6492d02349974351cfc32d2193c5f48473af6d7d165d6d9a04fafb9ea251cb2997cf0ea43e8eaaf6612c2bfb0bf59a203d3b3916d5d3f35b0181f984a1b5ab3e25c008f4ecc8a264437de70100c077e122eed2d020804cf6c467ddc81652651cfc41b5b4ef28f90ca1c81f7c271faea8cf3ecc0c507624b7e822246d9b935d557f9b23a6d503b8875ecabf229beeb87733692a4136132b36a1b90e25b0c8decceaf326581f44f19e716d9eba40dbb3eb5b58c76ea64d945bacf4f3a048fef8510edcbd177b0e79a7dcd54fe25768941d454d2a233c791833f90b830645a7562fffa4a28f17e119b5dcc097eb0d57359b62e2dabe2add83ee2295f1e72cee752f7f7f94dd99b9888c320d6d031a37b0e5861ee3478b74a374ea28b8a016901cb63d77330e5400748528bfbf742a1de415f7fb1705e5b20c90fed6f36c27400e0863f0da63f0fffd93eb11ec74e12b684ed94be8e16a3ba4c8f98f176c0c440bbac8f3331a29d2ebfd7a8cbc994fcc2d7fb961a956bff9aa5dfad1902674554947182c3a40214aae62260fe9cb5f885ef714723878503c003a8ca9436e482eb0099a3614a0e895cf408c168a1d753aed2120ee61c3fd5dac5518369d0b617403d2e0c5f7e59a1119b4f33eb1f01663b96aa345ea89628a4886177b5712e44926f825edbf1ea3dc3c1c70b18ac05c08625fb330ca02fcc7f05a8e82e3a4ea1ad8172344ac74b8e17beeda30d3b47bf6a82c842db3f51e77a27c9c9620654623da0dc59798a5aa234b5fbad7991e7b4941349d684c97b39acc69849d70753fecc51b319f466ddeb3ffcea487ab2c69eea99cc6450ed1c21ccc835534c30da3f2e2f93f77f9d93089bda4ae26365a8b11b6e75ed0af3f5d45dc195f4c6c7867bbcaabb462935085db8635bb98b5e698cb266c2b8b0c3ccf580719067efe3da6c21d1a9f37b5b8eba85f85f920edca26c3371e54d3e3990a0bbc913c5db1837403bfdd7db8d10d2a23aadb682b5b6b39678e136802f8f86cfa6dd033fe4c62b238a5763778a212197a8f537ff4637c0e767aec5e076eb5c0b286f91a4708befc4bca8f936f5ea3250262f3a35209dfea82aa8a88471135f488d9c56d6620b50aafbbdf1774cfc815364a72015939a0c569ea22c2fe3a0b644d12bc6896674906a34cad8a7aae3b55478efb6d547aaa4784bfa9e62317b960f5c9cedf201a2c5066d1bca1c331a0137052ab7d3e0907a939b6ce1b07648812d6b144146c39dc9fd985048f98e8db95c4155026fcdd1d1915e2845c83b729525de2630e9e340875b51078364df6800727143a4a9ce88031e28c783f43a70304086b51b1311d3e248034a330a67c1598c37db5d8cd17e0ae6ad120931efc6362c1c8303e6430924d9f19c4a0b8b5e56cb20e7f2a37e4543257dd0c001edd5dd57d64ac35aed5c51b5281c6c65563bdf4b8be9cf7bce08a3c4cb3d931cc022c5f8a136a99815a59b5ad31231866f2691c322fe23b1ad96ecdc744a994f137cf2a5cc3ab631d4f85a791dd9f50a9cf3740a1c0bde3006818b64e504ed58b6ba97e789503c19215b77df8081bbe158a771e79abb2faeda393944ef12bc9cd6ad73b2c68a9720581ad1028046a4b83069f674c80cca54b9104f7d3ff93a1804b615930b5eb5a34cca635b320ed9800b2088ec075d0cc3e58778995a389106b9e5902ccd78b6a057da05f1d5aaa33089eb6ea0b7b4847ee60cf974429cb112affcd45251fedf6dfdad96d967a50bde0b2dcf0e1a86208c76ff27b9aa89fa95f8fda29fd0f5b51a828b6d8fe2fb8e705bcaa86d54404f8580886f171d2a307d7b658402f2635b574d2cdf370d4a0be76e4fc403560fdf53e74bbb770d8f19265f87631bb4a2f3d125834818e15ad56e40d2143e59c92c248e9c070c9afb646a577b9fbd3638f53137d00dd13353cc66c24e75bb62e80b27c4d5f7b5188c78db70be03ed14f4c2033c5dbc4786794d896536f1b6847ee4da4e9cd2bcf7adb9c63865e9ee8d938a450dc26f7052b4aa4cfbc7a08140e77f544969e60e20faebb180cdf3c93b6c968b8a708e3bf4ddd93fa584de400e856d1f9f31b8143cb742928ce822e1f98aef63324cd1d490d76478f252194af0393648e4c07cc6c4b7b6210c4c5b7ccad87d967ce517946ee000fdf7b7a9587b2bb8f0b6f3ee1ef76cedb05c705f721240340fa0f6741255ff429c0ef1dd0f8fb70e2dbe5239d9246c0991f0d71238e55d9108bab79d343355f0f3b1a1f320d1d9e441cd3f8b8c483d29d7ddb61c57bf8533687c558eff0ea0de467a0bf2a2f8f672d694a53e5a8d59208504e8275bd2f68c598853817dbe8ed9ddca47175b7708bed0cd7d5e9934843fe091c666f99980a43bdfd5eaae4bccfea9251da84a5e5b1b13ec35da535ff23cdfaa3bb0b679c52e648bcec1a75499ba2d3a68ec954bbb939747f9f513b0eab4885fa40fda1345e5c4710fe4c56fb764ff96d1d651a6cae8d905dd0d0bad4cad5784930782799df19bccfd4442a692d7710510e3e23b9410b9a32e2da7694a1bb8dab4a86e3752b0e47694a642dcb18928c4c8fe8e078dc3a3012aec3d105471419f0be2b0d8515aca2f134d88a0369846ff80c963c1b78d359ad35ab6e7feceadff811a9ed2e4a28081d7e02e824c3fbbe6cbf5ddf0901a7060f3028160c8c76d3ff7344663bb343ab9bb774ee362797f2d229577c9e77ded5692eddda70fec5429794364cc8bb06312504cd09ab2478786cad53b6d2155b34ff4cab78c3b2816d296307e037171da2297355bfe7b39bff99106edb9acc2c612a3c4215610ab945bdc6873a43696e0c3687d841dfb07b80e78a74c7169c54e895aafa63625f8e0c4924b0b5c74317c522e450ced6fd54bb9da988b5a989dac4bf034fe9e563c139dc2a409746b0a62de330b5ae3ba98e492e0298947dca7c2adca931f4ae7fa3c65e6bb99812ff16f4aad9146bcd890a396aacaaba6e7d223f9a16842109ce45a17a51f603fa0fbdbe07e2d6629c6273a2c3a1daf2045d551f6692d4fa21e4b2d4c9c9c434f1e0e248b89f508f94e11cba749795a217538b86e9e8482c497a7aa476bf5d544b50a3ec8078a89f2eecf7617b1d83789239947a00c29e1e00c7dfa2947cb8593923168c8c6e10b78adab7b6b12661fb2e802db8352e4c32ac63288cd7fcc80a5a91636ec575399bc0576ba084c165677573e28e8d499ec170548c9472cdc9409e804e64ac9fc09a437d16493bb40f3b1c809f08689766981e110d6daa4c45a000e32961477d61a77dc4c40b868f767a0c6fe75f7e27e7b639a84aaf1f445b14bf8b03d79909359b40c0fd7239a03b1361fe7b9e2e9bd1677cfdce5f7cedaf0d00bc911cb72c6fab1734acfa288147fd31e48973a99a1ec7317b3745bbc87556122f9208dc667bc3462b1919898c74cc45dd741bead870f089d2d1a3e6e8321b01c2ba6c96627fc10f82bb7237084586349d2919e06ffe935c45d9114e727c6e0fc8f524a2163521787f26f34c977304b8fa1ba2b473e6171180038c6154794a52ba0a3cef7b13ad569cd7ff4142acaf19893f1a577720fc7e7de569bf8f3920ec481e0ade079997c07555aab806b0f38d93cac7e07daed0688d103b3ec3efff956e14c82d113347d541c8c4528b3122d02f3d10fef6fe1e5265f1fb72d915048e823a2ef6462418ee8dec75aeded273e7d06418a269ef9023cbf4c5f69ac9e9aeea80f3dfaba946d788be91b4f5638c51b8617fdc50a22658950e9f8fbc43ac7f29abda8a05c832be89464bc8e46fd145d7a9d3e85bd2c1b94984d523abd6700d0b140069839ec07f45ee34960788c536517905afcc95e95a7ab18ed595e0e32ea6e7d0dbf42355928c7f386fc0d5adb930e16f59ffe1e0fda001fcbcb58f821d73714957cc0e4275fd21183e87b3065f8a4d3866ac0ca4e9b1e0824de898caeebd5dedc3dd1ad22dfc20e230a8ae2a8d7e1b6549cb30b321c43b9723bfabb5cdf9b517d7537c6877e27bda9a29b086c68e851526d6b120069f51926b4d2bff736a8a4974daf8b4cb5e207ba4fe9bca8ca271d6c09ac9e3a29bb0f9e5a69fff9e2af175a5271dd3932eeb8fcd7421f08f97f27d4e668b132b690543d64faf2a09f0dc2a678987dd3c2ee183194193df3ca8ca8bc7b342919d2d9c60752acb745019418d9e4a0975a255f92a42ca83615c6cce023791735065adf7b77df5d6069ea3d5acbbfd9c0e0090789088dfd1441fd0e9209681ac8c8e5d505576660ca50b8af1210a2037527f3e628b991ea3cc95a5b4be4fca2b72d6003f0d08833b8da2779edf0fcafe90756c67a859ab30c22aa83076d71226d461c2e9291616378d4c84e8a5039a804def185d674aa91bd3d069a3cbbcddf31638c71579b8b73d6c6ed89570b5902f818bc4db18c5e9e6363a512b050c038a848199fe673dcaa187edd909dbf536816f681da628093c479e6dab809dc2d8de42480cf310f45bb95dc07d86f0f7d518d5056f3399bde91fbf7e8d1f79f80765aaa8ebfc64bc3f809c5b88b3c0c8b22dbe9b45b93b05b287e16ace0311ca3861bb8f160e544f0ff2b9ec0215a48b45d7907201e7eb56d8c42f24c47403c34e32d00ca7172322ee62529b352615c56f53380073352b61de87470394946d215ce054b00620bf136d2a55ca11ba8886f6a3f5818d1520ebb92ff08de85e058938936d7eb0a6abf30e137bdc1b0901d001d23554b954d6f09ba82e0f6ee86019651c1e52cdb6493e2ccc5f4745e92ce89f3a88c93ad2f21a5177fcf20d486abf47ce678ce3ffaced623dbdb2c5e8eef5b5f99e9bff7349c4760f9a965de763a6dea6b3e4379c75a448f62ff9c29865aa97ebd384ce86f23217f7ed5d2d353f939b69da7cd25756f600746a7ce1477e91ac0f39e8e053b72a6438b8102cbce2af2fa4440060c6e305ccfe785efdfeedf50e12dd012d7c4a6d337b5d4a2cd9164b6ea9bbb2277cd867e4fd334c260dc560e85740ca670be1c44637e0578b19a6933fc9d2bfb99cd8d36f2138bfa14bfcf51d5a63d7d056f554b918552cd1c6eee24428ad6617971e55ecf43281801f62a3f6efb10cc68e9c162960ea3c262e6c6438f06d708a6fa8861a749d86d84445873959cb5435d636580b0325a61c6ff25355f90c7e60623527f9296aed0e1f8f986f42f455489b8535a7aaeb2bd00000000000000000000000000000000000000000000000000000000060c11172224292f", "Z20a1A68e6818a1142F85671DB01eF7226debf822"},
	} {
		signer := NewShanghaiSigner(big.NewInt(1))

		var tx *Transaction
		err := rlp.DecodeBytes(common.Hex2Bytes(test.txRlp), &tx)
		if err != nil {
			t.Errorf("%d: %v", i, err)
			continue
		}

		from, err := Sender(signer, tx)
		if err != nil {
			t.Errorf("%d: %v", i, err)
			continue
		}

		addr, _ := common.NewAddressFromString(test.addr)
		if from != addr {
			t.Errorf("%d: expected %x got %x", i, addr, from)
		}
	}
}

func TestChainId(t *testing.T) {
	key, _ := defaultTestKey()

	tx := NewTx(&DynamicFeeTx{Nonce: 0, To: &common.Address{}, Value: new(big.Int), Gas: 0, GasFeeCap: new(big.Int), Data: nil})

	var err error
	tx, err = SignTx(tx, NewShanghaiSigner(big.NewInt(1)), key)
	if err != nil {
		t.Fatal(err)
	}

	_, err = Sender(NewShanghaiSigner(big.NewInt(2)), tx)
	if !errors.Is(err, ErrInvalidChainId) {
		t.Error("expected error:", ErrInvalidChainId, err)
	}

	_, err = Sender(NewShanghaiSigner(big.NewInt(1)), tx)
	if err != nil {
		t.Error("expected no error")
	}
}
